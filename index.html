<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drachma Bank - Digital Banking MVP</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            background-image: 
                linear-gradient(45deg, rgba(255, 215, 0, 0.03) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(255, 215, 0, 0.03) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, rgba(255, 215, 0, 0.03) 75%),
                linear-gradient(-45deg, transparent 75%, rgba(255, 215, 0, 0.03) 75%);
            background-size: 60px 60px;
            background-position: 0 0, 0 30px, 30px -30px, -30px 0px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, transparent 0%, rgba(255, 215, 0, 0.1) 50%, transparent 100%),
                linear-gradient(0deg, transparent 0%, rgba(255, 215, 0, 0.1) 50%, transparent 100%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            background: #1a1a1a;
            border: 3px solid #FFD700;
            border-radius: 15px;
            box-shadow: 
                0 0 30px rgba(255, 215, 0, 0.3),
                inset 0 0 30px rgba(255, 215, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 500px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .logo {
            font-size: 3rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            letter-spacing: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .logo img {
            width: 400px;
            height: auto;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
            transition: transform 0.3s ease;
            object-fit: contain;
        }


        .subtitle {
            color: #CCCCCC;
            margin-bottom: 30px;
            font-size: 1.1rem;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #FFD700;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #333;
            border-radius: 10px;
            font-size: 16px;
            background: #2a2a2a;
            color: #FFFFFF;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            background: #333;
        }

        .form-group input::placeholder {
            color: #888;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: #FFD700;
            color: #1a1a1a;
            border: 2px solid #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            background: #FFF700;
        }

        .btn-secondary {
            background: transparent;
            color: #FFD700;
            border: 2px solid #FFD700;
        }

        .btn-secondary:hover {
            background: #FFD700;
            color: #1a1a1a;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: 2px solid #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
            border: 2px solid #28a745;
        }

        .btn-success:hover {
            background: #218838;
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
        }

        .balance-display {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #FFD700;
            box-shadow: 
                0 0 30px rgba(255, 215, 0, 0.4),
                inset 0 0 30px rgba(255, 255, 255, 0.1);
        }

        .balance-amount {
            font-size: 3rem;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .balance-full {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
            font-weight: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        /* Responsive font sizing for very large numbers */
        .balance-amount.large-number {
            font-size: 2.5rem;
        }

        .balance-amount.very-large-number {
            font-size: 2rem;
        }

        .balance-amount.extremely-large-number {
            font-size: 1.5rem;
        }

        .balance-label {
            font-size: 1.1rem;
            opacity: 0.8;
            font-weight: 600;
        }

        .transaction-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #FFD700;
        }

        .transaction-section h3 {
            color: #FFD700;
            text-shadow: none;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .leaderboard-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #FFD700;
        }

        .leaderboard-section h3 {
            color: #FFD700;
            text-shadow: none;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.2rem;
            text-align: center;
        }

        .leaderboard {
            background: #2a2a2a;
            border: 2px solid #FFD700;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: #333;
            border-radius: 8px;
            border: 1px solid #555;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .leaderboard-item:hover {
            background: #444;
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        .leaderboard-item.current-user {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a1a1a;
            border-color: #FFD700;
            font-weight: bold;
        }

        .leaderboard-rank {
            font-weight: bold;
            color: #FFD700;
            min-width: 30px;
        }

        .leaderboard-item.current-user .leaderboard-rank {
            color: #1a1a1a;
        }

        .leaderboard-username {
            flex: 1;
            margin-left: 15px;
            color: #FFFFFF;
        }

        .leaderboard-item.current-user .leaderboard-username {
            color: #1a1a1a;
        }

        .leaderboard-balance {
            font-weight: bold;
            color: #51cf66;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }

        .leaderboard-balance .balance-full {
            font-size: 0.7rem;
            opacity: 0.6;
            font-weight: normal;
            margin-top: 2px;
        }

        .leaderboard-item.current-user .leaderboard-balance {
            color: #1a1a1a;
        }

        .leaderboard-item.current-user .leaderboard-balance .balance-full {
            color: #1a1a1a;
            opacity: 0.7;
        }

        .loading-text {
            text-align: center;
            color: #888;
            font-style: italic;
        }

        .transaction-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .transaction-form input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #333;
            border-radius: 10px;
            font-size: 16px;
            background: #2a2a2a;
            color: #FFFFFF;
            transition: all 0.3s ease;
        }

        .transaction-form input:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            background: #333;
        }

        .transaction-form input::placeholder {
            color: #888;
        }

        .transaction-form button {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .hidden {
            display: none;
        }

        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border: 2px solid #ff6b6b;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.2);
        }

        .success {
            color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
            border: 2px solid #51cf66;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(81, 207, 102, 0.2);
        }

        .user-info {
            background: #2a2a2a;
            border: 2px solid #FFD700;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .user-info strong {
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* Balance History Chart Styles */
        .chart-tooltip {
            position: fixed;
            background: #1a1a1a;
            border: 2px solid #FFD700;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            z-index: 1000;
            pointer-events: none;
            min-width: 350px;
            max-width: 450px;
        }

        .chart-tooltip h4 {
            color: #FFD700;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 200px;
        }

        .chart-container canvas {
            max-width: 100%;
            height: 200px;
        }

        .no-data-message {
            color: #888;
            font-style: italic;
            text-align: center;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
        }

        .debug-section {
            background: #2a2a2a;
            border: 2px solid #FFD700;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
        }

        .debug-section h4 {
            color: #FFD700;
            margin-bottom: 10px;
        }

        .debug-info {
            color: #CCCCCC;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .transaction-form {
                flex-direction: column;
            }

            .chart-tooltip {
                min-width: 280px;
                max-width: 320px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Logo and Title -->
        <div class="logo">
            <img src="drachma.png" alt="Drachma Coin"> DRACHMA BANK
        </div>
        <div class="subtitle">Your Digital Banking Solution</div>

        <!-- Error/Success Messages -->
        <div id="message" class="hidden"></div>

        <!-- Login/Register Form -->
        <div id="auth-section">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            <button class="btn btn-primary" onclick="login()">Login</button>
            <button class="btn btn-secondary" onclick="register()">Create Account</button>
        </div>

        <!-- Banking Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- User Info -->
            <div class="user-info">
                <div>
                    <strong id="user-email"></strong>
                </div>
                <button class="btn btn-danger" onclick="logout()" style="width: auto; padding: 8px 16px;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <!-- Balance Display -->
            <div class="balance-display">
                <div class="balance-label">Current Balance</div>
                <div class="balance-amount" id="balance">$0.00</div>
            </div>

            <!-- Transaction Section -->
            <div class="transaction-section">
                <h3>Make a Transaction</h3>
                
                <div class="transaction-form">
                    <input type="number" id="amount" placeholder="Amount" step="0.01" min="0.01">
                    <button class="btn btn-success" onclick="deposit()" style="width: auto; padding: 12px 20px;">
                        <i class="fas fa-plus"></i> Deposit
                    </button>
                </div>
                
                <div class="transaction-form">
                    <input type="number" id="withdraw-amount" placeholder="Amount" step="0.01" min="0.01">
                    <button class="btn btn-danger" onclick="withdraw()" style="width: auto; padding: 12px 20px;">
                        <i class="fas fa-minus"></i> Withdraw
                    </button>
                </div>
                
                <div class="transaction-form">
                    <button class="btn btn-danger" onclick="withdrawFullBalance()" style="width: 100%; padding: 12px 20px; margin-top: 10px;">
                        <i class="fas fa-money-bill-wave"></i> Withdraw Full Balance
                    </button>
                </div>
            </div>

            <!-- Debug Section -->
            <div class="debug-section">
                <h4>üîß Debug Info</h4>
                <div class="debug-info" id="debug-info">
                    <div>‚Ä¢ Hover over leaderboard users to see balance history</div>
                    <div>‚Ä¢ Make deposits/withdrawals to create history data</div>
                    <div>‚Ä¢ Check browser console (F12) for detailed logs</div>
                    <div style="color: #ff6b6b; margin-top: 10px;">‚ö†Ô∏è Update Firebase rules to enable balance history!</div>
                </div>
            </div>

            <!-- Balance History Management -->
            <div class="transaction-section">
                <h3>Balance History</h3>
                <div class="transaction-form">
                    <button class="btn btn-danger" onclick="clearBalanceHistory()" style="width: 100%; padding: 12px 20px;">
                        <i class="fas fa-trash-alt"></i> Clear Balance History
                    </button>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div class="leaderboard-section">
                <h3><i class="fas fa-trophy"></i> Top 10 Leaderboard</h3>
                <div class="leaderboard" id="leaderboard">
                    <div class="loading-text">Loading leaderboard...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Tooltip -->
    <div id="chart-tooltip" class="chart-tooltip hidden">
        <h4 id="tooltip-title">Balance History</h4>
        <div class="chart-container">
            <canvas id="tooltip-chart"></canvas>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, getDocs, collection, addDoc, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCdhL0E7UobxPOhW4yYPzdxB350cCDYoCM",
            authDomain: "drachma-62a89.firebaseapp.com",
            projectId: "drachma-62a89",
            storageBucket: "drachma-62a89.firebasestorage.app",
            messagingSenderId: "886975863054",
            appId: "1:886975863054:web:47a118342c559050ce9f5f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let chartTooltip = null;
        let tooltipChart = null;

        // Format number with abbreviations
        function formatNumberWithAbbreviation(num) {
            if (num < 1000) {
                return {
                    abbreviated: num.toFixed(2),
                    full: num.toFixed(2)
                };
            } else if (num < 1000000) {
                const abbreviated = (num / 1000).toFixed(2);
                return {
                    abbreviated: abbreviated + 'k',
                    full: num.toFixed(2)
                };
            } else if (num < 1000000000) {
                const abbreviated = (num / 1000000).toFixed(2);
                return {
                    abbreviated: abbreviated + 'M',
                    full: num.toFixed(2)
                };
            } else if (num < 1000000000000) {
                const abbreviated = (num / 1000000000).toFixed(2);
                return {
                    abbreviated: abbreviated + 'B',
                    full: num.toFixed(2)
                };
            } else if (num < 1000000000000000) { // 1 quadrillion
                const abbreviated = (num / 1000000000000).toFixed(2);
                return {
                    abbreviated: abbreviated + 'T',
                    full: num.toFixed(2)
                };
            } else {
                // For numbers >= 1 quadrillion, show in quadrillions
                const abbreviated = (num / 1000000000000000).toFixed(2);
                return {
                    abbreviated: abbreviated + 'Q',
                    full: num.toFixed(2)
                };
            }
        }

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showDashboard();
                loadUserBalance();
            } else {
                currentUser = null;
                showAuth();
            }
        });

        // Show authentication form
        function showAuth() {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        // Show banking dashboard
        function showDashboard() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('user-email').textContent = currentUser.email;
            loadUserBalance();
            loadLeaderboard();
        }

        // Show message
        function showMessage(message, type = 'error') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = type;
            messageDiv.classList.remove('hidden');
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }

        // Register new user
        window.register = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showMessage('Please fill in all fields');
                return;
            }

            if (password.length < 6) {
                showMessage('Password must be at least 6 characters');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Create user document with initial balance
                await setDoc(doc(db, 'users', user.uid), {
                    email: email,
                    balance: 0.00,
                    createdAt: new Date()
                });

                // Create initial balance history entry
                await addDoc(collection(db, 'balanceHistory'), {
                    userId: user.uid,
                    balance: 0.00,
                    timestamp: new Date(),
                    type: 'initial'
                });

                showMessage('Account created successfully!', 'success');
            } catch (error) {
                console.error('Registration error:', error);
                showMessage(error.message);
            }
        };

        // Login user
        window.login = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showMessage('Please fill in all fields');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('Login successful!', 'success');
            } catch (error) {
                console.error('Login error:', error);
                showMessage(error.message);
            }
        };

        // Logout user
        window.logout = async function() {
            try {
                await signOut(auth);
                showMessage('Logged out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showMessage(error.message);
            }
        };

        // Load user balance
        async function loadUserBalance() {
            if (!currentUser) return;

            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const formatted = formatNumberWithAbbreviation(userData.balance);
                    const balanceElement = document.getElementById('balance');
                    
                    // Apply responsive font sizing based on number size
                    balanceElement.className = 'balance-amount';
                    if (userData.balance >= 1e15) { // 1 quadrillion or more
                        balanceElement.classList.add('extremely-large-number');
                    } else if (userData.balance >= 1e12) { // 1 trillion or more
                        balanceElement.classList.add('very-large-number');
                    } else if (userData.balance >= 1e9) { // 1 billion or more
                        balanceElement.classList.add('large-number');
                    }
                    
                    balanceElement.innerHTML = `$${formatted.abbreviated}<div class="balance-full">$${formatted.full}</div>`;
                }
            } catch (error) {
                console.error('Error loading balance:', error);
                showMessage('Error loading balance');
            }
        }

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const leaderboardDiv = document.getElementById('leaderboard');
                leaderboardDiv.innerHTML = '<div class="loading-text">Loading leaderboard...</div>';

                // Get all users
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const users = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.balance !== undefined) {
                        users.push({
                            id: doc.id,
                            email: userData.email,
                            balance: userData.balance
                        });
                    }
                });

                console.log('Loaded users for leaderboard:', users.length);

                // Sort by balance (descending)
                users.sort((a, b) => b.balance - a.balance);

                // Take top 10
                const top10 = users.slice(0, 10);

                // Display leaderboard
                if (top10.length === 0) {
                    leaderboardDiv.innerHTML = '<div class="loading-text">No users found. Be the first to make a deposit!</div>';
                    return;
                }

                let leaderboardHTML = '';
                top10.forEach((user, index) => {
                    const isCurrentUser = currentUser && user.id === currentUser.uid;
                    const rank = index + 1;
                    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
                    const formatted = formatNumberWithAbbreviation(user.balance);
                    
                    leaderboardHTML += `
                        <div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}" 
                             data-user-id="${user.id}" 
                             data-user-email="${user.email}"
                             onmouseenter="showBalanceHistory(event, '${user.id}', '${user.email}')"
                             onmouseleave="hideBalanceHistory()">
                            <div class="leaderboard-rank">${medal} ${rank}</div>
                            <div class="leaderboard-username">${user.email}</div>
                            <div class="leaderboard-balance">
                                $${formatted.abbreviated}
                                <div class="balance-full">$${formatted.full}</div>
                            </div>
                        </div>
                    `;
                });

                leaderboardDiv.innerHTML = leaderboardHTML;
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                console.error('Error details:', error.message);
                document.getElementById('leaderboard').innerHTML = `
                    <div class="loading-text">
                        Error loading leaderboard: ${error.message}<br>
                        <small>Check console for details</small>
                    </div>
                `;
            }
        }

        // Show balance history chart
        window.showBalanceHistory = async function(event, userId, userEmail) {
            console.log('showBalanceHistory called for:', userEmail, 'ID:', userId);
            
            try {
                // Get balance history for user
                const historySnapshot = await getDocs(collection(db, 'balanceHistory'));
                const history = [];
                
                console.log('Total history documents found:', historySnapshot.size);
                
                historySnapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('Checking document:', doc.id, 'userId:', data.userId, 'target userId:', userId);
                    if (data.userId === userId) {
                        history.push({
                            balance: data.balance,
                            timestamp: data.timestamp.toDate()
                        });
                    }
                });

                console.log('Found history entries for', userEmail, ':', history.length);

                // Sort by timestamp
                history.sort((a, b) => a.timestamp - b.timestamp);

                // Show tooltip
                const tooltip = document.getElementById('chart-tooltip');
                const title = document.getElementById('tooltip-title');
                title.textContent = `${userEmail} - Balance History`;
                tooltip.classList.remove('hidden');

                // Smart positioning to prevent clipping
                const mouseX = event.clientX;
                const mouseY = event.clientY;
                const tooltipWidth = 450; // Max width
                const tooltipHeight = 300; // Approximate height
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                let left = mouseX + 10;
                let top = mouseY - 10;
                
                // Adjust if tooltip would go off right edge
                if (left + tooltipWidth > viewportWidth) {
                    left = mouseX - tooltipWidth - 10;
                }
                
                // Adjust if tooltip would go off bottom edge
                if (top + tooltipHeight > viewportHeight) {
                    top = viewportHeight - tooltipHeight - 20;
                }
                
                // Ensure tooltip doesn't go off left edge
                if (left < 10) {
                    left = 10;
                }
                
                // Ensure tooltip doesn't go off top edge
                if (top < 10) {
                    top = 10;
                }
                
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';

                // Destroy existing chart
                if (tooltipChart) {
                    tooltipChart.destroy();
                    tooltipChart = null;
                }

                if (history.length === 0) {
                    // Show no data message
                    const chartContainer = document.querySelector('.chart-container');
                    chartContainer.innerHTML = '<div class="no-data-message">No balance history available<br><small>Make a deposit or withdrawal to create history</small></div>';
                } else {
                    // Ensure canvas exists
                    const chartContainer = document.querySelector('.chart-container');
                    chartContainer.innerHTML = '<canvas id="tooltip-chart"></canvas>';

                    // Get fresh canvas reference
                    const canvas = document.getElementById('tooltip-chart');
                    const ctx = canvas.getContext('2d');

                    // Prepare data with exact time
                    const labels = history.map(h => {
                        const date = h.timestamp;
                        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    });
                    const data = history.map(h => h.balance);

                    console.log('Creating chart with data:', { labels, data });

                    tooltipChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Balance',
                                data: data,
                                borderColor: '#FFD700',
                                backgroundColor: 'rgba(255, 215, 0, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        color: '#CCCCCC',
                                        maxTicksLimit: 6,
                                        maxRotation: 45,
                                        minRotation: 0
                                    },
                                    grid: {
                                        color: '#333'
                                    }
                                },
                                y: {
                                    ticks: {
                                        color: '#CCCCCC',
                                        callback: function(value) {
                                            return '$' + value.toFixed(2);
                                        }
                                    },
                                    grid: {
                                        color: '#333'
                                    }
                                }
                            }
                        }
                    });
                }

            } catch (error) {
                console.error('Error loading balance history:', error);
                const tooltip = document.getElementById('chart-tooltip');
                const title = document.getElementById('tooltip-title');
                title.textContent = `${userEmail} - Error`;
                tooltip.classList.remove('hidden');
                
                const chartContainer = document.querySelector('.chart-container');
                chartContainer.innerHTML = '<div class="no-data-message">Error loading data</div>';
            }
        };

        // Hide balance history chart
        window.hideBalanceHistory = function() {
            const tooltip = document.getElementById('chart-tooltip');
            tooltip.classList.add('hidden');
        };

        // Record balance history
        async function recordBalanceHistory(userId, balance, type) {
            try {
                await addDoc(collection(db, 'balanceHistory'), {
                    userId: userId,
                    balance: balance,
                    timestamp: new Date(),
                    type: type
                });
                console.log('Recorded balance history:', { userId, balance, type });
            } catch (error) {
                console.error('Error recording balance history:', error);
                // Don't show error to user as this is background functionality
            }
        }

        // Deposit money
        window.deposit = async function() {
            const amount = parseFloat(document.getElementById('amount').value);
            
            if (!amount || amount <= 0) {
                showMessage('Please enter a valid amount');
                return;
            }

            try {
                // Get current balance before transaction
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const currentBalance = userDoc.data().balance;
                
                // Record pre-transaction balance
                await recordBalanceHistory(currentUser.uid, currentBalance, 'pre_deposit');
                
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    balance: increment(amount)
                });
                
                // Get updated balance
                const updatedUserDoc = await getDoc(userRef);
                const newBalance = updatedUserDoc.data().balance;
                
                // Record post-transaction balance
                await recordBalanceHistory(currentUser.uid, newBalance, 'deposit');
                
                document.getElementById('amount').value = '';
                loadUserBalance();
                loadLeaderboard();
                showMessage(`Deposited $${amount.toFixed(2)} successfully!`, 'success');
            } catch (error) {
                console.error('Deposit error:', error);
                showMessage('Error processing deposit');
            }
        };

        // Withdraw money
        window.withdraw = async function() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            
            if (!amount || amount <= 0) {
                showMessage('Please enter a valid amount');
                return;
            }

            try {
                // Check if user has sufficient balance
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const currentBalance = userDoc.data().balance;
                
                if (amount > currentBalance) {
                    showMessage('Insufficient funds');
                    return;
                }

                // Record pre-transaction balance
                await recordBalanceHistory(currentUser.uid, currentBalance, 'pre_withdrawal');

                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    balance: increment(-amount)
                });
                
                // Get updated balance
                const updatedUserDoc = await getDoc(userRef);
                const newBalance = updatedUserDoc.data().balance;
                
                // Record post-transaction balance
                await recordBalanceHistory(currentUser.uid, newBalance, 'withdrawal');
                
                document.getElementById('withdraw-amount').value = '';
                loadUserBalance();
                loadLeaderboard();
                showMessage(`Withdrew $${amount.toFixed(2)} successfully!`, 'success');
            } catch (error) {
                console.error('Withdrawal error:', error);
                showMessage('Error processing withdrawal');
            }
        };

        // Withdraw full balance
        window.withdrawFullBalance = async function() {
            if (!currentUser) return;

            try {
                // Get current balance
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const currentBalance = userDoc.data().balance;
                
                if (currentBalance <= 0) {
                    showMessage('No funds available to withdraw');
                    return;
                }

                // Confirm withdrawal
                const confirmWithdraw = confirm(`Are you sure you want to withdraw your full balance of $${currentBalance.toFixed(2)}?`);
                if (!confirmWithdraw) return;

                // Record pre-transaction balance
                await recordBalanceHistory(currentUser.uid, currentBalance, 'pre_full_withdrawal');

                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    balance: increment(-currentBalance)
                });
                
                // Get updated balance (should be 0)
                const updatedUserDoc = await getDoc(userRef);
                const newBalance = updatedUserDoc.data().balance;
                
                // Record post-transaction balance
                await recordBalanceHistory(currentUser.uid, newBalance, 'full_withdrawal');
                
                loadUserBalance();
                loadLeaderboard();
                showMessage(`Withdrew full balance of $${currentBalance.toFixed(2)} successfully!`, 'success');
            } catch (error) {
                console.error('Full withdrawal error:', error);
                showMessage('Error processing full withdrawal');
            }
        };

        // Clear balance history
        window.clearBalanceHistory = async function() {
            if (!currentUser) return;

            try {
                // Confirm deletion
                const confirmClear = confirm('Are you sure you want to clear all your balance history? This action cannot be undone.');
                if (!confirmClear) return;

                // Get all balance history documents for this user
                const historyQuery = query(
                    collection(db, 'balanceHistory'),
                    where('userId', '==', currentUser.uid)
                );
                
                const historySnapshot = await getDocs(historyQuery);
                
                if (historySnapshot.empty) {
                    showMessage('No balance history found to clear');
                    return;
                }

                // Delete all balance history documents
                const deletePromises = [];
                historySnapshot.forEach((docSnapshot) => {
                    deletePromises.push(deleteDoc(docSnapshot.ref));
                });

                await Promise.all(deletePromises);
                
                showMessage(`Cleared ${historySnapshot.size} balance history records successfully!`, 'success');
                console.log(`Cleared ${historySnapshot.size} balance history records for user ${currentUser.uid}`);
            } catch (error) {
                console.error('Error clearing balance history:', error);
                showMessage('Error clearing balance history');
            }
        };
    </script>
</body>
</html>